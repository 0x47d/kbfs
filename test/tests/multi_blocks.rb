# These tests all do one conflict-free operation while a user is unstaged.
module Test
  # alice writes a multi-block file, and bob reads it
  test :write_multiblock_file, block_size: 20, writers: ["alice", "bob"] do |alice, bob|
    as alice do
      write "a/b", "012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789"
    end
    as bob do
      read "a/b", "012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789"
    end
  end

  # bob removes a multiblock file written by alice (checks that state
  # is cleaned up)
  test :rm_multiblock_file, block_size: 20, writers: ["alice", "bob"] do |alice, bob|
    as alice do
      write "a/b", "012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789"
    end
    as bob do
      read "a/b", "012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789"
      rm "a/b"
    end
    as alice do
      lsdir "a/", { }
    end
  end

  # bob renames something over a multiblock file written by alice
  # (checks that state is cleaned up)
  test :rename_over_multiblock_file, block_size: 20, writers: ["alice", "bob"] do |alice, bob|
    as alice do
      write "a/b", "012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789"
      write "a/c", "hello"
    end
    as bob do
      read "a/b", "012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789"
      read "a/c", "hello"
      rename "a/c", "a/b"
    end
    as alice do
      read "a/b", "hello"
      lsdir "a/", { "b" => "FILE" }
    end
  end

  # bob writes a second copy of a multiblock file written by alice
  # (tests dedupping, but hard to verify that precisely here).
  test :copy_multiblock_file, block_size: 20, writers: ["alice", "bob"] do |alice, bob|
    as alice do
      write "a/b", "012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789"
    end
    as bob do
      read "a/b", "012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789"
      write "a/c", "012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789"
    end
    as alice do
      read "a/b", "012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789"
      read "a/c", "012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789"
      rm "a/b"
    end
    as bob do
      read "a/c", "012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789"
    end
  end
end
